/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
"use strict";var response={},pdfURL=null,incognito=!1,VIEWER_URL=chrome.extension.getURL("viewer.html");require(["common","util","analytics"],(function(e,t,n){function o(n){!function(){try{let n=0!=communicate.version&&1!=communicate.version,o=!(!n||communicate.version===SETTINGS.READER_VER||communicate.version===SETTINGS.ERP_READER_VER);localStorage.setItem("locale",t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"))),localStorage.setItem("cdnUrl",e.getAcrobatViewerUri()),localStorage.setItem("isDeskTop",n),localStorage.setItem("env",e.getEnv()),localStorage.setItem("viewerImsClientId",e.getViewerIMSClientId()),localStorage.setItem("imsURL",e.getIMSurl()),localStorage.setItem("isAcrobat",o)}catch(e){}}();let o=VIEWER_URL;if(o+="?pdfurl="+encodeURIComponent(n.url),void 0!==n.responseHeaders){const e=s(n.responseHeaders,"content-length");e&&(o+="&clen="+e.value);const t=s(n.responseHeaders,"accept-ranges");t&&t.value&&"bytes"===t.value.toLowerCase()&&(o+="&chunk=true")}return o}function r(e){if(!SETTINGS.IS_READER&&SETTINGS.USE_ACROBAT&&0!=communicate.version&&(1!=communicate.version||0!=t.getNMHConnectionStatus())&&e.url){const t=new URL(e.url);chrome.runtime.id===t.host?(chrome.contextMenus.update("convertPageContextMenu",{visible:!1}),chrome.contextMenus.update("appendPageContextMenu",{visible:!1})):(chrome.contextMenus.update("convertPageContextMenu",{visible:!0}),chrome.contextMenus.update("appendPageContextMenu",{visible:!0}))}}function i(e){const n=new Date;n.setMinutes(n.getMinutes()+SETTINGS.VIEWER_RECHECK_CDN_ACCESS_DELAY_MINS),t.setCookie("netAccAdT",n.getTime()),t.setCookie("netAcc",e)}chrome.tabs.onActivated.addListener((function(e){chrome.tabs.get(e.tabId,(function(e){chrome.runtime.lastError||r(e)}))}));function a(){try{return"true"===t.getCookie("pdfViewer")}catch(e){return!1}}function s(e,t){for(var n=0;n<e.length;++n){var o=e[n];if(o.name.toLowerCase()===t)return o}}function c(e,t){e&&t&&chrome.tabs.update(e,{url:t})}function u(e){if("GET"!==e.method||!SETTINGS.VIEWER_ENABLED||!a())return!1;var o=e.url;let r="reloadurl-"+e.tabId;const i=t.getCookie(r);if(i&&i===o){try{localStorage.removeItem(r)}catch(e){}return!1}if(!(e=>{if(!e||null===e||"undefined"===e)return!1;return!![/^http\:\/\/[^/]/,/^https\:\/\/[^/]/].find(t=>t.test(e))&&![/^chrome\:\/\//,/^chrome\-extension\:\/\//,/^file?:/,/^https:\/\/([a-zA-Z\d-]+\.){0,}officeapps.live.com/,/^https\:\/\/*.*\/(saml|login)/,/^https:\/\/sharedcloud.([a-zA-Z\d-]+)+.(s3|s3-accelerate).amazonaws.com/,/^https\:\/\/*.*.(login|auth|okta|saml).*\/S*|(login|auth|okta|saml|IWA|owa)\//,/^https\:\/\/www.google.com\/search\?q/,/^https\:\/\/www.citibank.*/,/^https:\/\/[^/]*\.*\/([$-/:-?{-~!"^_`\[\]A-Za-z0-9]*)view-sdk/].find(t=>t.test(e))})(o))return!1;const c=function(e){if(void 0!==e.responseHeaders){const t=s(e.responseHeaders,"content-type"),o=s(e.responseHeaders,"content-disposition");if(t){const r=t.value.toLowerCase().split(";",1)[0].trim();if(o&&/^\s*attachment[;]?/i.test(o.value))return"application/pdf"===r||"application/octet-stream"===r?n.event(n.e.VIEWER_PDF_ATTACHMENT_IGNORED):n.event(n.e.VIEWER_ATTACHMENT_IGNORED),!1;if("application/pdf"===r)return n.event(n.e.VIEWER_PDF_PROCESS_PDF),!0;if("application/octet-stream"===r){if(e.url.toLowerCase().indexOf(".pdf")>0)return n.event(n.e.VIEWER_PDF_PROCESS_OS_URL),!0;if(o&&/\.pdf(["']|$)/i.test(o.value))return n.event(n.e.VIEWER_PDF_PROCESS_OS_CD),!0}}}return!1}(e);return incognito?(c&&n.event(n.e.VIEWER_FALLBACK_TO_NATIVE_INCOGNITO),!1):c}chrome.tabs.onUpdated.addListener((e,t,n)=>{if(incognito=n.incognito,"complete"===n.status&&r(n),"loading"===t.status)try{!function(e,t){return chrome.runtime.id===e.host&&t.url.indexOf("viewer.html")>0}(new URL(n.url),n)||a()&&!incognito||c(e,function(e,t){t||(t=window.location.href);try{const n=new URL(t);return new URLSearchParams(n.search).get(e)}catch(e){return}}("pdfurl",n.url))}catch(e){}}),chrome.webRequest.onHeadersReceived.addListener((function(e){if("main_frame"===e.type){if(!function(){if(!window.navigator.onLine)return!1;const e=new Date,n=t.getCookie("netAcc"),o=t.getCookie("netAccAdT");return!(o&&o>e.getTime())||"true"===n}()||!u(e))return;return n.event(n.e.VIEWER_PDF_DETECT_HEADERS),pdfURL=e.url,{redirectUrl:o(e)}}var r;"sub_frame"===e.type&&(r=e.url,/^https:\/\/[^/]*(acrobat|adobe)\.com\/proxy\/chrome-viewer/.test(r))&&(200!==e.statusCode?403===e.statusCode?(t.setCookie("pdfViewer",!1),n.event(n.e.VIEWER_FALLBACK_TO_NATIVE_CDN_FORBIDDEN),c(e.tabId,pdfURL)):(i(!1),n.event(n.e.VIEWER_FALLBACK_TO_NATIVE_CDN_OFFLINE),c(e.tabId,pdfURL)):i(!0))}),{urls:["http://*/*","https://*/*"],types:["main_frame","sub_frame"]},["responseHeaders","blocking"])}));