/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
!function(){let e,t,n,a,r,i,o,s,l,d,c;function f(e){let t;try{t=localStorage.getItem(e)}catch(e){}return t}function u(e,t){try{localStorage.setItem(e,t)}catch(e){}}function p(e){try{localStorage.removeItem(e)}catch(e){}}function m(e){const t=new URL(window.location.href);return new URLSearchParams(t.search).get(e)}function g(){try{setTimeout(()=>{let e=m("pdfurl");chrome.tabs.getCurrent((function(t){u("reloadurl-"+t.id,e),window.location.href=e}))},500)}catch(e){R("fallback to native failed",e)}}function w(){setTimeout(()=>{const e=m("pdfurl");window.location.href=e},200)}const h=e=>{try{const t=new URL(f("cdnUrl")),n=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return e===t.origin&&!!n.find(t=>t.test(e))}catch(e){return!1}};function _(e){const t={main_op:"analytics"};t.analytics=[[e]],chrome.runtime.sendMessage(t)}const y=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write"],b=f("viewerImsClientId"),v=f("imsURL");const L={isSharePointURL:!1,isSharePointFeatureEnabled:!1};class E{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=e=>{const t=window.document,n=t.createElement("iframe");n.setAttribute("src",e),n.setAttribute("id","dc-view-frame"),n.setAttribute("allowfullscreen","allowfullscreen"),n.style.width="100vw",n.style.height="100vh",n.style.border="none",n.style.overflow="hidden",this.parentDiv.appendChild(n),this.iframeElement=t.getElementById("dc-view-frame")};_sendMessage=(e,t)=>{this.iframeElement&&h(t)&&a&&this.iframeElement.contentWindow.postMessage(e,t)};sendFileMetaData=(e,t,n,a,r,i,o)=>{this._sendMessage({fileUrl:r,fileName:i,fileSize:n,acceptRanges:a,handShakeTime:t,type:e},o)};sendProgress=(e,t,n,a)=>{this._sendMessage({total:t,loaded:n,type:e},a)};sendInitialBuffer=(e,t,n,a,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:n,buffer:a},r)};sendBufferRanges=(e,t,n,a)=>{this._sendMessage({type:e,range:t,buffer:n},a)};preview=(e,t,n,a,r,i,o)=>{this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:a,downLoadstartTime:r,downLoadEndTime:i},o)};openInAcrobatResponse=(e,t,n)=>{this._sendMessage({type:e,res:t},n)};postLog=(e,t,n,a,r)=>{this._sendMessage({type:e,reqId:t,message:n,error:a},r)}}function R(e,n){try{l=void 0!==l?l:"false"!==f("logAnalytics"),l&&(o&&t?o.postLog("log",s,e,n,t.origin):setTimeout(()=>{o&&t&&o.postLog("log",s,e,n,t.origin)},500))}catch(e){}}function I(e){if(n)return n;let t=e;try{const n=e.split("?")[0].split("/").filter(e=>e.length>0),a=n.length>0?n[n.length-1]:"untitled";t=a;const r=a.length-4;(a.length<4||a.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){R("Error in getFileNameFromURL",e)}return t}function D(t,n){return new Promise((a,r)=>{const i=(new Date).getTime(),o=new XMLHttpRequest;o.open("GET",t.url),o.responseType="arraybuffer",o.setRequestHeader("Range",`bytes=${n.start}-${n.end}`),o.onload=()=>{if(4===o.readyState&&206===o.status)a({buffer:o.response,startTime:i,endTime:(new Date).getTime()});else if(200===o.status){const t={status:o.status,statusText:o.statusText,fileSize:e,rangeBufferSize:o.response.byteLength,range:n};r({message:"Unexpected response to get file buffer range",error:t})}else{const t={status:o.status,statusText:o.statusText,fileSize:e,range:n};r({message:"Invalid response to get file buffer ranger",error:t})}},o.onerror=e=>{r({message:"Error to get file buffer range",error:e})},o.ontimeout=e=>{r({message:"Timeout to get file buffer range due to timeout",error:e})},o.send()})}function S(t,a,r){return new Promise((o,s)=>{const l=m("pdfurl");if(l.startsWith("file://"))return void function(e,t){const n=new XMLHttpRequest;n.open("GET",e),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(200!==n.status&&0!=n.status||t({buffer:n.response,mimeType:n.getResponseHeader("content-type")}))},n.send(null)}(l,o);const d=new XMLHttpRequest;d.open("GET",l),d.responseType="arraybuffer",a&&d.setRequestHeader("If-Range","randomrange"),d.onreadystatechange=function(t,a,r,o){return function(s){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const n=e.getResponseHeader("content-type"),a=e.getResponseHeader("content-disposition");if(n){const e=n.toLowerCase().split(";",1)[0].trim();if(a&&/^\s*attachment[;]?/i.test(a.value))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e){if(t.toLowerCase().indexOf(".pdf")>0)return!0;if(a&&/\.pdf(["']|$)/i.test(a.value))return!0}}return!1}(t,r))return R("Fall back to native - not pdf from headers"),w();const s=t.getResponseHeader("Content-Disposition"),l="bytes"===t.getResponseHeader("Accept-Ranges")?"true":"false";if(e=t.getResponseHeader("Content-Length")||-1,s&&/\.pdf(["']|$)/i.test(s)){const t=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(s);null!=t&&t.length>1&&(n=t[1].replace(/['"]/g,""),document.title=n,i&&e&&a.sendFileMetaData("metadata",i,e,l,encodeURI(r),n,o))}}}}(d,t,l,r),d.onprogress=function(t,n){return function(a){a.lengthComputable&&(e=a.total,t.sendProgress("progress",a.total,a.loaded,n))}}(t,r),d.onload=()=>{if(d.status>=200&&d.status<400)o({buffer:d.response,mimeType:d.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime()});else{const e={status:d.status,statusText:d.statusText};s({message:"Invalid response fetching content",error:e})}},d.onerror=e=>{s({message:"Error to download file contents",error:e})},d.ontimeout=e=>{s({message:"Timeout to download file contents",error:e})},d.send()})}function T(e,t){switch(t.data.main_op){case"open_in_acrobat":case"fillsign":!function(e,t){const n={main_op:"open_in_acrobat"};if("fillsign"===t.data.main_op&&(n.paramName="FillnSign"),n.url=t.data.url,n.click_context="pdfviewer",n.timeStamp=Date.now(),t.data.fileBuffer){const e=new Blob([t.data.fileBuffer],{type:"application/pdf"});n.dataURL=URL.createObjectURL(e)}function a(n){"fillsign"===t.data.main_op?e.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",n,t.origin):e.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",n,t.origin),R(`Open In Acrobat - (${t.data.main_op}) response- ${n}`)}"true"===f("isSharepointFeatureEnabled")?L.isSharePointURL?(n.workflow_name="SharePoint",n.isSharePointURL=!0,chrome.runtime.sendMessage(n,a)):util.checkForSharePointURL(n.url,e=>{n.isSharePointURL=e,n.isSharePointURL&&(n.workflow_name="SharePoint"),chrome.runtime.sendMessage(n,a)}):chrome.runtime.sendMessage(n,a)}(e,t);break;case"complete_conversion":_("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),chrome.runtime.sendMessage(t)}(t);break;case"updateLocale":_("DCBrowserExt:Viewer:User:Locale:Updated"),u("viewer-locale",t.data.locale),chrome.tabs.reload();break;case"setInitialLocale":let n=!1;f("viewer-locale")||(n=!0,u("viewer-locale",t.data.locale),_("DCBrowserExt:Viewer:User:Locale:Initial")),t.data.reloadReq&&n&&chrome.tabs.reload();break;case"deleteViewerLocale":f("viewer-locale")&&(p("viewer-locale"),chrome.tabs.reload())}}function P(r,s,l,d,c){a=!0;const f=m("pdfurl"),u=m("chunk")||"false";r.sendFileMetaData("metadata",i,e,u,encodeURI(f),n||I(f),s.origin),l?(_("DCBrowserExt:Viewer:Linearization:Range:Supported"),R("Range call supported"),l.then(e=>{r.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,s.origin),function(e){try{const n=new TextDecoder("utf-8").decode(e.buffer);let a=!1;-1!=n.indexOf("</Linearized 1/")?(a=!0,_("DCBrowserExt:Viewer:Linearization:Linearized:Version:1"),R("Linearized PDF v1 detected")):-1!=n.indexOf("</Linearized")?(_("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"),R("Linearized PDF other version detected")):(_("DCBrowserExt:Viewer:Linearization:Linearized:False"),R("Non Linearized PDF detected")),o._sendMessage({type:"Linearization",linearized:a},t.origin)}catch(e){_("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),R("Linearization Detection failed",e)}}(e)}).catch(e=>{r.sendInitialBuffer("initialBuffer",0,0,-1,s.origin),_("DCBrowserExt:Viewer:Error:Linearization:InitialBuffer:Failed"),R("Initial buffer download failed",e)})):(_("DCBrowserExt:Viewer:Linearization:Range:Not:Supported"),R("Range call not supported"),r.sendInitialBuffer("initialBuffer",0,0,-1,s.origin)),d.then(a=>{const i=a.downLoadEndTime,l=a.buffer;a.buffer.byteLength;r.preview("preview",l,e,n||I(f),c,i,s.origin),o._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},t.origin)}).catch(e=>(_("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),R("File download failed, falling back to native viewer",e),g())),R("Viewer loaded")}function C(e,t,n,a){return r=>{try{if(r.data&&r.origin&&h(r.origin)){if(r.data.main_op)return T(e,r);switch(r.data.type){case"ready":P(e,r,n,t,a);break;case"getFileBufferRange":!function(e,t){D({url:m("pdfurl")},e.data.range).then(n=>{c||(_("DCBrowserExt:Viewer:Linearization:Range:Called"),R("Range call received"),c=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,n.buffer,e.origin)}).catch(n=>{_("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),R(`Range buffer download failed for ${e.data.range.start}-${e.data.range.end}`,n),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)})}(r,e);break;case"previewFailed":d||(_("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),R("File preview failed, falling back to native viewer","previewFailed"),d=!0,g());break;case"signin":_("DCBrowserExt:Viewer:Ims:Sign:In"),function(){const e=new URL(v+"/ims/authorize/v1?");e.searchParams.append("response_type","token"),e.searchParams.append("client_id",b),e.searchParams.append("redirect_uri",window.location.href),e.searchParams.append("scope",y.join(",")),e.searchParams.append("locale",f("locale")),chrome.tabs.update({url:e.href,active:!0})}();break;case"signout":_("DCBrowserExt:Viewer:Ims:Sign:Out"),p("viewer-locale"),function(){const e=new URL(v+"/ims/logout/v1?");e.searchParams.append("client_id",b),e.searchParams.append("redirect_uri",window.location.href),chrome.tabs.update({url:e.href,active:!0})}()}}}catch(e){_("DCBrowserExt:Viewer:Error:MessageHandler:Unknown"),R("Unknown error","MessageHandler")}}}function x(){if(!r)return _("DCBrowserExt:Viewer:Error:Handshake:TimedOut"),R("Handshake timed out - falling back to native","Timeout"),g(),!1}(()=>{try{!function(){try{let e=window.location.href;e&&e.indexOf("#")>-1&&(e=e.split("#")[0],R("URL hash detected"),window.location.href=e)}catch(e){}}();const n=window.document.getElementById("Adobe-dc-view");e=m("clen")||-1,o=new E(n);const a=(()=>{try{const e=f("cdnUrl"),n=new URL(e);h(n.origin)||(R("Invalid CDN URL detected","Invalid Origin"),g()),t||(t=n);let a=f("viewer-locale");a||(a=f("locale"));const r="false"!==f("logAnalytics");n.searchParams.append("locale",a),n.searchParams.append("logAnalytics",r),n.searchParams.append("isDeskTop",f("isDeskTop")),n.searchParams.append("isAcrobat",f("isAcrobat")),n.searchParams.append("callingApp",chrome.runtime.id);const i=["dropin!","provider!","app!"],o=["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization"],s=(f("env"),new URLSearchParams(window.location.search));s.forEach((e,t)=>{o.forEach(a=>{t===a&&n.searchParams.append(t,e)})});let l=n.href;return s.forEach((e,t)=>{i.forEach(n=>{t.startsWith(n)&&(l=l+"&"+t+"="+e)})}),l}catch(e){R("Iframe src creation failed",e),g()}})();o.createIframe(a),window.addEventListener("message",e=>{!e.data||!h(e.origin)||r||"hsready"!==e.data.type&&"ready"!==e.data.type||(r=!0,i=(new Date).getTime(),s=e.data.requestId,"on"===e.data.killSwitch?(_("DCBrowserExt:Viewer:KillSwitch:Turned:On"),R("KillSwitch turned On","KillSwitch"),u("pdfViewer",!1),u("killSwitch","on"),w()):f("killSwitch")&&(_("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),R("KillSwitch turned Off"),p("killSwitch")),R("Handshake done"))})}catch(e){R("Error create Iframe",e)}})();function B(e){const t=document.getElementById("__acrobatDialog__");t&&0!==t.length?t&&"none"===t.style.display&&"visible"===e.frame_visibility?t.style.display="block":t&&e.trefoilClick&&(delete e.trefoilClick,t.remove()):function(e){const t=e.base64PDF;delete e.base64PDF;const n="message="+encodeURIComponent(JSON.stringify(e));e.base64PDF=t;let a=e.version>13?"166px":"120px",r="block";"hidden"===e.frame_visibility&&(r="none");const i=document.createElement("iframe");i.setAttribute("src",`${chrome.extension.getURL("data/js/frame.html")}?${n}`),i.setAttribute("id","__acrobatDialog__"),i.style.border="0px",i.style.zIndex="999999999999",i.style.position="fixed",i.style.top="-5px",i.style.right="80px",i.style.width="275px",i.style.height=a,i.style.display=r,i.style.margin="auto",document.getElementById("trefoil_m").appendChild(i)}(e)}(()=>{try{const e=m("clen")||-1,n=m("chunk")||!1,a="false"!==m("linearization"),r={url:m("pdfurl")},i=(new Date).getTime(),s=new URL(f("cdnUrl"));t||(t=s);let l=null;const d=a&&n&&e>0;d&&(l=D(r,{start:0,end:1024}));const c=S(o,d,s.origin);window.addEventListener("message",C(o,c,l,i)),setTimeout(x,25e3)}catch(e){R("InitScript failed",e),g()}})(),document.title=decodeURIComponent(I(m("pdfurl"))),document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();var n=window.setInterval((function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(n),e.call(this))}),200)}((function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()}))),void 0!==chrome.runtime&&(chrome.runtime.onMessage.addListener((function(e){if(e.panel_op&&(1==e.trefoilClick?(delete e.trefoilUI,delete e.newUI,B(e)):!0===e.reload_in_native&&(delete e.is_viewer,chrome.tabs.reload(e.tabId))),"relay_to_content"!==e.main_op||"dismiss"!==e.content_op)return"viewer-startup-response"===e.main_op?(L.isSharePointURL=!!e.isSharePointURL,L.isSharePointFeatureEnabled=!!e.isSharePointEnabled):"reset"===e.main_op&&o._sendMessage({type:"toggleAnalytics",logAnalytics:e.analytics_on},t.origin),!1;{delete e.content_op,delete e.trefoilClick,delete e.reload_in_native;let t=document.getElementById("__acrobatDialog__");t&&(t.remove(),t=null)}})),chrome.runtime.sendMessage({main_op:"viewer-startup",url:document.location.href,startup_time:Date.now(),viewer:!0}))}();